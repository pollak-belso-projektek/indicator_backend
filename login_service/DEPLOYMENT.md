# Login Service Deployment Guide

## Overview

The Login Service is a dedicated microservice that handles authentication for the Indicator application. It has been extracted from the main backend to improve scalability and maintainability.

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │  Main Backend   │    │ Login Service   │
│   (Port 5173)   │    │   (Port 5300)   │    │   (Port 5301)   │
│                 │    │                 │    │                 │
│  User Login ────┼────┼─ Auth Routes ───┼────┼─ Authentication │
│                 │    │                 │    │                 │
│  API Calls ─────┼────┼─ Protected ─────┼    │                 │
│                 │    │   Routes        │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                │                       │
                                └───────────────────────┘
                                     Database
```

## Features

- **User Authentication**: Login with email/password
- **JWT Token Management**: Access and refresh token generation
- **Token Validation**: Secure token verification
- **Health Monitoring**: Comprehensive health checks
- **API Documentation**: Swagger/OpenAPI documentation
- **Database Integration**: PostgreSQL with Prisma ORM
- **Error Handling**: Robust error handling and logging
- **Caching**: In-memory caching for performance
- **Docker Support**: Containerization ready

## Quick Start

### Prerequisites

- Node.js 18+
- PostgreSQL database
- npm or yarn

### Installation

1. **Navigate to the login service directory:**

   ```bash
   cd login_service
   ```

2. **Run the setup script:**

   ```bash
   # Linux/macOS
   chmod +x setup.sh
   ./setup.sh

   # Windows
   setup.bat
   ```

3. **Configure environment variables:**

   ```bash
   cp .env.example .env
   # Edit .env with your actual values
   ```

4. **Start the service:**

   ```bash
   # Development
   npm run dev

   # Production
   npm start
   ```

## Environment Configuration

### Required Environment Variables

```env
PORT=5301
DATABASE_URL=postgresql://username:password@localhost:5432/indicator_db
JWT_SECRET=your_super_secret_jwt_key
JWT_REFRESH_SECRET=your_super_secret_refresh_key
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
NODE_ENV=development
```

### Optional Environment Variables

```env
# Database retry configuration
DB_RETRY_MAX_ATTEMPTS=5
DB_RETRY_INITIAL_DELAY=1000
DB_RETRY_MAX_DELAY=30000
DB_RETRY_BACKOFF_MULTIPLIER=2

# Allow degraded start
ALLOW_DEGRADED_START=false
```

## Main Backend Integration

The main backend has been updated to communicate with the login service:

### Updates Made

1. **New LoginServiceClient** (`utils/loginServiceClient.js`):

   - Handles communication with login service
   - Provides login and refresh methods
   - Includes health check functionality

2. **Updated Auth Service** (`services/auth.service.js`):

   - Delegates authentication to login service
   - Maintains same API contract

3. **New Token Client** (`utils/tokenClient.js`):

   - Verifies tokens generated by login service
   - Maintains backward compatibility

4. **Updated Middleware** (`middleware/auth.middleware.js`):

   - Uses new token client for verification
   - Handles login service token refresh

5. **Enhanced Health Checks**:
   - Monitors login service health
   - Provides degraded status when login service is down

### Main Backend Configuration

Add to your main backend's `.env`:

```env
LOGIN_SERVICE_URL=http://localhost:5301
JWT_SECRET=your_super_secret_jwt_key
JWT_REFRESH_SECRET=your_super_secret_refresh_key
```

## Docker Deployment

### Single Service

```bash
# Build the image
docker build -t login-service .

# Run the container
docker run -p 5301:5301 \
  -e DATABASE_URL="postgresql://..." \
  -e JWT_SECRET="your_secret" \
  -e JWT_REFRESH_SECRET="your_refresh_secret" \
  login-service
```

### With Docker Compose

```bash
# Start the service
docker-compose up -d
```

## API Endpoints

### Authentication

- `POST /api/v1/auth/login` - User login
- `POST /api/v1/auth/refresh` - Refresh access token

### Health Checks

- `GET /health` - Complete health check
- `GET /health/basic` - Basic service health
- `GET /health/database` - Database health

### Documentation

- `GET /api-docs` - Swagger UI
- `GET /api-docs.json` - OpenAPI specification

## Monitoring and Logging

### Health Checks

The service provides multiple health check endpoints:

```bash
# Basic health (no database check)
curl http://localhost:5301/health/basic

# Database health
curl http://localhost:5301/health/database

# Complete health check
curl http://localhost:5301/health
```

### Logging

Logs include:

- Authentication attempts
- Token operations
- Database operations
- Health check results
- Error conditions

## Security Considerations

1. **JWT Secrets**: Use strong, unique secrets for JWT_SECRET and JWT_REFRESH_SECRET
2. **Database Security**: Ensure database connections are secured
3. **Network Security**: Use HTTPS in production
4. **CORS Configuration**: Properly configure allowed origins
5. **Environment Variables**: Never commit .env files to version control

## Production Deployment

### Recommended Setup

1. **Load Balancer**: Use a load balancer for high availability
2. **Database**: Use managed PostgreSQL service
3. **Monitoring**: Implement proper monitoring and alerting
4. **Logging**: Use centralized logging service
5. **Secrets Management**: Use proper secrets management
6. **SSL/TLS**: Enable HTTPS

### Scaling

- The service is stateless and can be horizontally scaled
- Database connections should be pooled
- Consider using Redis for caching in multi-instance deployments

## Troubleshooting

### Common Issues

1. **Database Connection Errors**:

   - Check DATABASE_URL format
   - Verify database is accessible
   - Check network connectivity

2. **JWT Token Errors**:

   - Ensure JWT_SECRET matches between services
   - Verify token expiration settings
   - Check token format and encoding

3. **Service Communication Errors**:
   - Verify LOGIN_SERVICE_URL in main backend
   - Check network connectivity between services
   - Verify CORS configuration

### Debug Mode

Enable debug logging:

```env
NODE_ENV=development
```

### Health Checks

Use health endpoints to diagnose issues:

```bash
# Check if service is running
curl http://localhost:5301/health/basic

# Check database connectivity
curl http://localhost:5301/health/database

# Check overall health
curl http://localhost:5301/health
```

## Migration Notes

### From Monolith to Microservice

The authentication functionality has been extracted while maintaining:

- Same API contracts
- Backward compatibility
- Existing user data
- Token format compatibility

### Database

The login service uses the same database as the main backend but only accesses the `users` table. No migration is required.

## Support

For issues and questions:

1. Check the logs for error details
2. Verify environment configuration
3. Test health endpoints
4. Check network connectivity between services
